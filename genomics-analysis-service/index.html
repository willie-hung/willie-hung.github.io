<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genomics Analysis Service</title>
    <link rel="icon" href="./img/dna.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./main.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css"
    />
  </head>
  <body>
    <section class="section">
      <div class="container">
        <div class="level">
          <div
            class="level-item is-flex is-flex-direction-row is-justify-content-center is-align-items-center"
          >
            <figure class="image">
              <image width="20px" src="./img/dna-3.png" />
            </figure>
            <h1 class="title has-text-centered">
              &nbsp Genomics Analysis Service
            </h1>
          </div>
        </div>

        <hr />

        <div class="content">
          <h2>üéØ Overview</h2>
          <p>
            A fully operational software-as-a-service(SaaS) for genomics
            analysis.
          </p>
        </div>

        <div class="content">
          <h4>Tech Stack</h4>
          <div
            class="is-flex is-flex-direction-row is-flex-wrap-wrap is-justify-content-center is-align-items-baseline"
          >
            <div>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg"
                  />
                </span>
                <span>Python</span>
              </button>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/flask/flask-original.svg"
                  />
                </span>
                <span>Flask</span>
              </button>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/amazonwebservices/amazonwebservices-original.svg"
                  />
                </span>
                <span>AWS</span>
              </button>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/postgresql/postgresql-original.svg"
                  />
                </span>
                <span>PostgreSQL</span>
              </button>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/javascript/javascript-original.svg"
                  />
                </span>
                <span>JavaScript</span>
              </button>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/html5/html5-original.svg"
                  />
                </span>
                <span>HTML</span>
              </button>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/css3/css3-original.svg"
                  />
                </span>
                <span>CSS</span>
              </button>
              <button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/bootstrap/bootstrap-original.svg"
                  />
                </span>
                <span>Bootstrap</span>
              </button>
            </div>
          </div>

          <h4 id="diagram">Diagram</h4>

          <div class="box">
            <div
              class="is-flex is-justify-content-center is-align-items-center"
            >
              <figure class="image column is-two-thirds">
                <image src="./img/overview.jpg" />
              </figure>
            </div>
          </div>
        </div>

        <div class="content pt-4">
          <h2>‚öôÔ∏è Environment Setup</h2>
        </div>

        <div class="content pt-4">
          <h2>üî® Building Process</h2>
          <h4>1Ô∏è‚É£ Building the Annotator API</h4>
          <div class="box">
            <h5>Objectives</h5>
            <p>
              Build an API for accessing a cloud-hosted computing service (AWS).
            </p>

            <h5>What is annotation?</h5>
            <p>
              Annotation is a process by which a sequenced genome sample is
              analyzed to identify the locations of genes and all of the coding
              regions in a genome, and determine what those genes do.
            </p>

            <h5>The science behind dna annotation</h5>
            <p>
              <a
                href="https://www.ncbi.nlm.nih.gov/books/NBK20253/"
                target="_blank"
                ><span class="tag is-link is-light">Link</span></a
              >
            </p>

            <h5>AnnTool</h5>
            <p>
              I utilize
              <a href="https://anntools.sourceforge.net/" target="_blank"
                >AnnTools</a
              >
              and
              <a
                href="https://github.com/DipanshuSehjal/anntools"
                target="_blank"
                >this modified version</a
              >, one of the many available open source annotations tools, to
              perform the analysis.
            </p>

            <h5>Flask framework</h5>
            <p>
              I need an application server that can accept HTTP requests and
              server responses. I use the
              <a
                href="https://flask.palletsprojects.com/en/2.3.x/"
                target="_blank"
                >Flask Python web microframework</a
              >
              to implement the annotator API.
            </p>

            <h5>REST API</h5>
            <p>
              Implement a service with an API that allows users to run
              annotation jobs and check on their status.
            </p>
            <ul>
              <li>
                <p>
                  <span class="tag is-primary is-light">GET</span>
                </p>
                <ul>
                  <li>
                    <p>
                      <strong>Endpoint:</strong>
                      http://{DOMAIN}/annotations/{job_id}
                    </p>
                  </li>
                  <li>
                    <strong>Response data:</strong>
                  </li>
                  <ul>
                    <li>
                      code (HTTP response code, integer) and status (‚Äúsuccess‚Äù
                      or ‚Äúerror‚Äù)
                    </li>
                    <li>job_id (UUID, string)</li>
                    <li>job_status (string)</li>
                    <li>
                      log (contents of log file for completed job, string)
                    </li>
                  </ul>
                </ul>
                <hr />
                <ul>
                  <li>
                    <p>
                      <strong>Endpoint:</strong> http://{DOMAIN}/annotations
                    </p>
                  </li>
                  <li>
                    <strong>Response data:</strong>
                  </li>
                  <ul>
                    <li>
                      code (HTTP response code, integer) and status (‚Äúsuccess‚Äù
                      or ‚Äúerror‚Äù)
                    </li>
                    <li>jobs (list of jobs)</li>
                    <ul>
                      <li>job_id (UUID, string)</li>
                      <li>
                        job_details (URL to get job status via endpoint above)
                      </li>
                    </ul>
                  </ul>
                </ul>
              </li>

              <li><span class="tag is-warning is-light">POST</span></li>
              <ul>
                <li>
                  <p><strong>Endpoint:</strong> http://{DOMAIN}/annotations</p>
                </li>
                <li>
                  <strong>Request body:</strong>
                  input_file (string)
                </li>
                <li>
                  <strong>Response data:</strong>
                </li>
                <ul>
                  <li>
                    code (HTTP response code, integer) and status (‚Äúsuccess‚Äù or
                    ‚Äúerror‚Äù)
                  </li>
                  <li>job_id (UUID, string)</li>
                  <li>input_file (string)</li>
                </ul>
              </ul>
            </ul>

            <h5>Running Environment</h5>
            <p>
              Both AnnTool and the API server are running on AWS EC2 instances
            </p>

            <h5>Test the API</h5>
            <p>
              Utilize
              <a href="https://www.postman.com/" target="_blank">Postman</a> to
              submit request data and view responses.
            </p>
          </div>

          <h4>2Ô∏è‚É£ Uploading Data to Object Storage: Amazon S3</h4>
          <div class="box">
            <h5>Objectives</h5>
            <p>
              To become familiar with object storage and authenticated calls
              (signed requests) to cloud API.
            </p>
            <h5>Approach</h5>
            <p>
              Utilize <a href="#diagram">2 Amazon S3 buckets</a> to store user
              input files and annotated result files.
            </p>
            <h5>Working with large files</h5>
            <p>
              S3 provides a way for us to upload large files directly from a web
              browser. It requires that we create a signed request and POST that
              request to the URL of our S3 bucket. The S3 service then takes
              over and uploads the file directly via the browser, bypassing our
              app server.
            </p>
            <h5>Protect your credentials</h5>
            <h6>Signed requests</h6>
            <p>
              For signed requests, AWS supports two types of signatures. When
              you refer to documentation on working with signed requests make
              sure it pertains to Version 4 signatures. To Learn more about
              signed requests, see the
              <a
                href="https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-UsingHTTPPOST.html"
                target="_blank"
                >AWS documentation here</a
              >.
            </p>
            <h6>Instance profile</h6>
            <p>
              Launch instances with a special type of permission attached, and
              boto3 will automagically find and use your credentials on the
              instance. This is a far superior (i.e. more secure) approach,
              because keys are not physically stored on the instance and AWS
              automatically refreshes (i.e. expires and renews) these temporary
              keys as needed. In order to enable this, we will launch instances
              and attach an
              <a
                href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html#ec2-instance-profile"
                target="_blank"
                >instance profile</a
              >
              to the instance; this profile includes permissions in the form of
              an instance role that will allow applications running on the
              instance to access other AWS resources on your behalf.
            </p>
            <h5>Add new endpoints</h5>

            <ul>
              <li><span class="tag is-warning is-light">POST</span></li>
              <ul>
                <li>
                  <p><strong>Endpoint:</strong> http://{DOMAIN}/annotate</p>
                </li>
                <li>
                  <strong>Purpose:</strong>
                  User will navigate to this endpoint, browse and select a file,
                  and click the button to upload it to the S3 bucket.
                </li>
                <li>
                  <strong>Important:</strong>
                  Must contain an expiration timestamp. This is a critical part
                  of a signed request: the request must be completed before the
                  specified time otherwise it is rendered invalid. Furthermore,
                  your policy document must, at minimum, contain conditions for
                  the ACL, which is critical for security.
                </li>
              </ul>

              <li><span class="tag is-primary is-light">GET</span></li>
              <ul>
                <li>
                  <p>
                    <strong>Endpoint:</strong> http://{DOMAIN}/annotate/files
                  </p>
                </li>
                <li>
                  <strong>Purpose:</strong>
                  Gets a list of objects from your S3 input bucket and returns
                  them in a JSON object:
                </li>
              </ul>
            </ul>
          </div>

          <h4>3Ô∏è‚É£ Application Decoupling - Front/Back-End Separation</h4>
          <div class="box">
            <h5>Objectives</h5>
            <p>
              Building out the distributed infrastructure for this DNA
              annotation service.
            </p>
            <h5 id="step3-diagram">Diagram</h5>
            <div
              class="is-flex is-justify-content-center is-align-items-center"
            >
              <figure class="image column is-two-thirds">
                <image src="./img/step3.jpg" />
              </figure>
            </div>
            <h5>Approach</h5>
            <p>
              Utilize
              <a href="#step3-diagram">two EC2 instances</a>: one running the
              web application server and the other running the annotation
              server.
            </p>
            <ul>
              <li>
                Separate the code that serves the user interface from the code
                that implements the API and runs AnnTools.
              </li>
              <li>
                Modify annotator.py so that it downloads the input file from S3
                and saves it to the AnnTools instance (into a file structure
                that ensures uniqueness for multiple jobs running
                simultaneously).
              </li>
              <li>
                Modify run.py scripts so that, after completion, it copies the
                annotated results file and the associated log from the local
                volume on your annotator instance to the S3 results bucket.
                After copying, the local files on the AnnTools instance must be
                deleted (otherwise the EBS volume attached to your instance
                would eventually run out of space).
              </li>
            </ul>
          </div>

          <h4>4Ô∏è‚É£ Persisting Data in a Key-Value Store</h4>
          <div class="box">
            <h5>Objectives</h5>
            <p>
              Add persistence that enables distributed services to operate with
              greater durability.
            </p>
            <h5 id="step3-diagram">Diagram</h5>
            <div
              class="is-flex is-justify-content-center is-align-items-center"
            >
              <figure class="image column is-two-thirds">
                <image src="./img/step4.jpg" />
              </figure>
            </div>
            <h5>Approach</h5>
            <p>
              We are adding a key-value store (KVS) to persist annotation job
              information and allow both services to access/update a job as its
              status changes. We will use DynamoDB for this purpose. We‚Äôre using
              a KVS because we assert that annotation data will be irregular and
              hence better suited to a schema-less database
            </p>
            <h5>The application flow till now</h5>
            <ul>
              <li>
                User selects an input file which is uploaded to S3 via a signed
                POST request.
              </li>
              <li>
                S3 sends a request to the redirect URL which must now (going
                back again!) be handled by our web app, and not by the
                annotator.
              </li>
              <li>
                The web app creates an item in the database; sets status to
                ‚ÄúPENDING‚Äù.
              </li>
              <li>The web app POSTs a request to the annotator.</li>
              <li>The annotator downloads the input file from S3.</li>
              <li>
                The annotator spawns the annotation and updates the job‚Äôs status
                to ‚ÄúRUNNING‚Äù.
              </li>
              <li>The annotator copies the result and log files to S3.</li>
              <li>
                The annotator again updates the job‚Äôs status in the database to
                ‚ÄúCOMPLETED‚Äù.
              </li>
            </ul>
          </div>
          <h4>5Ô∏è‚É£ Application Decoupling Using Message Queues</h4>
          <div class="box"></div>
          <h4>6Ô∏è‚É£ User Notifications</h4>
          <div class="box"></div>
          <h4>7Ô∏è‚É£ Data Archival</h4>
          <div class="box"></div>
          <h4>8Ô∏è‚É£ Subscription Upgrade (Stripe Integration)</h4>
          <div class="box"></div>
          <h4>9Ô∏è‚É£ Data Restoration</h4>
          <div class="box"></div>
          <h4>üîü Scaling the Web Server</h4>
          <div class="box"></div>
        </div>

        <div class="content pt-4">
          <h2>üÜö Different Approach</h2>
          <h4>Webhook vs. Data Polling</h4>
        </div>

        <div class="content pt-4">
          <h2>üìù Final Feature</h2>
          <h4>‚úÖ Scaling</h4>
        </div>

        <div class="content pt-4">
          <h2>üíª Source Code</h2>
          <div class="is-flex">
            <div class="is-flex is-align-items-center mr-2">
              <p>Require GitLab permission:</p>
            </div>
            <a href="mailto:sungjiehung@gmail.com" target="_blank"
              ><button class="button">
                <span class="icon">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/gitlab/gitlab-original.svg"
                  />
                </span>
                <span>GitLab</span>
              </button></a
            >
          </div>
        </div>
      </div>
    </section>
    <footer class="footer">
      <div class="content has-text-centered">
        <p>
          Blog post written by
          <strong
            ><a href="https://sungjiehung.com/" target="_blank"
              >Sung-Jie Hung</a
            ></strong
          >
          ‚ù§Ô∏è
        </p>
        <p>Last update: <strong>Jul 6, 2023</strong></p>
      </div>
    </footer>

    <script
      src="https://kit.fontawesome.com/7119540adb.js"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
